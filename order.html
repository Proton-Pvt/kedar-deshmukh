<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Your Order</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
body {
  font-family: Inter, sans-serif;
  background: #f4f4f4;
  margin: 0;
  padding: 20px;
}

.card {
  background: #fff;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.cart-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-bottom: 1px solid #eee;
}

.cart-item img {
  width: 70px;
  height: 60px;
  border-radius: 8px;
  object-fit: cover;
}

.name { font-weight: 700; }
.price { font-weight: 700; margin-left: auto; }

.qty-box {
  display: flex;
  align-items: center;
  gap: 5px;
}

.qty-btn {
  padding: 4px 10px;
  border: none;
  border-radius: 4px;
  background: #222;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
}

.remove-btn {
  padding: 4px 10px;
  background: red;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.input-box {
  width: 100%;
  padding: 12px;
  border-radius: 6px;
  border: 1px solid #ccc;
  margin-bottom: 10px;
}

.btn {
  background: #111;
  color: #fff;
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: none;
  cursor: pointer;
}

.status-box{
  padding: 6px 10px;
  background: #eee;
  border-radius: 6px;
  font-weight: 600;
  display:inline-block;
}

#popup {
  position: fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background: rgba(0,0,0,0.6);
  display:none;
  align-items:center;
  justify-content:center;
}
#popup .box {
  background:#fff;
  padding:20px;
  border-radius:10px;
  text-align:center;
  width:300px;
}

</style>
</head>

<body>

<h1>Your Cart</h1>

<div class="card">
  <h2>Cart Items</h2>
  <div id="cartList"></div>
  <h3>Total: ₹<span id="totalPrice">0</span></h3>
</div>

<div class="card">
  <h2>Customer Details</h2>

  <input class="input-box" id="name" placeholder="Full Name">
  <input class="input-box" id="phone" placeholder="Phone Number">
  <textarea class="input-box" id="address" placeholder="Delivery Address"></textarea>

  <button class="btn" id="placeOrderBtn">Place Order</button>
</div>

<div class="card">
  <h2>Track Your Order</h2>

  <input class="input-box" id="checkPhone" placeholder="Enter Phone Number">
  <button class="btn" id="checkStatusBtn">Check Status</button>

  <div id="stepsUI" style="margin-top:20px;"></div>
</div>


<div id="popup">
  <div class="box">
    <h2>Order Placed ✔</h2>
    <p>Your order has been successfully placed!</p>
    <button class="btn" onclick="closePopup()">OK</button>
  </div>
</div>


<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, addDoc, serverTimestamp,
  query, where, onSnapshot 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrj_dMhYpdRZeKIYTAckYdqGE4f0FBz8w",
  authDomain: "restaurant-database-1ca9d.firebaseapp.com",
  projectId: "restaurant-database-1ca9d",
  storageBucket: "restaurant-database-1ca9d.firebasestorage.app",
  messagingSenderId: "772678372956",
  appId: "1:772678372956:web:1e517b1f963d58f3c1a099",
  measurementId: "G-2DWFVJLB6E"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


let cart = JSON.parse(localStorage.getItem("cart") || "[]");
const cartList = document.getElementById("cartList");
let total = 0;

function renderCart() {
  cartList.innerHTML = "";
  total = 0;

  if (cart.length === 0) {
    cartList.innerHTML = "<p>Your cart is empty.</p>";
    return;
  }

  cart.forEach((item, index) => {
    item.price = Number(item.price);
    item.qty = Number(item.qty) || 1;

    total += item.price * item.qty;

    cartList.innerHTML += `
      <div class="cart-item">
        <img src="${item.img}">
        <div class="name">${item.name}</div>

        <div class="qty-box">
          <button class="qty-btn" onclick="updateQty(${index}, -1)">-</button>
          <span>${item.qty}</span>
          <button class="qty-btn" onclick="updateQty(${index}, 1)">+</button>
        </div>

        <div class="price">₹${item.price * item.qty}</div>

        <button class="remove-btn" onclick="removeItem(${index})">X</button>
      </div>
    `;
  });

  document.getElementById("totalPrice").innerText = total;
}

window.updateQty = function(index, change) {
  cart[index].qty += change;
  if (cart[index].qty <= 0) cart.splice(index,1);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

window.removeItem = function(index) {
  cart.splice(index, 1);
  localStorage.setItem("cart", JSON.stringify(cart));
  renderCart();
}

renderCart();



document.getElementById("placeOrderBtn").addEventListener("click", async ()=>{

  let name = document.getElementById("name").value;
  let phone = document.getElementById("phone").value;
  let address = document.getElementById("address").value;

  if(!name || !phone){
    alert("Name & Phone Required!");
    return;
  }

  await addDoc(collection(db, "orders"), {
    customerName: name,
    phone: phone,
    address: address,
    items: cart,
    totalAmount: total,
    status: "Pending",
    createdAt: serverTimestamp()
  });

  localStorage.removeItem("cart");
  openPopup();
});


window.openPopup = function(){
  document.getElementById("popup").style.display = "flex";
};
window.closePopup = function(){
  document.getElementById("popup").style.display = "none";
  location.reload();
};



function renderSteps(status){
  let steps = ["Pending", "Confirmed", "Preparing", "Out for Delivery", "Completed"];
  let html = "";

  steps.forEach(step => {
    let active = steps.indexOf(step) <= steps.indexOf(status);
    html += `
      <div style="
        padding:10px;
        margin-bottom:8px;
        border-radius:6px;
        font-weight:600;
        background:${active ? '#2ecc71' : '#eee'};
        color:${active ? 'white':'#333'};
      ">
        ${step}
      </div>
    `;
  });

  document.getElementById("stepsUI").innerHTML = html;
}

document.getElementById("checkStatusBtn").addEventListener("click", ()=>{

  let phone = document.getElementById("checkPhone").value;

  const q = query(collection(db, "orders"), where("phone","==",phone));

  onSnapshot(q,(snapshot)=>{
    if(snapshot.empty){
      document.getElementById("stepsUI").innerHTML = "<p>No order found.</p>";
      return;
    }

    snapshot.forEach(doc=>{
      let data = doc.data();
      renderSteps(data.status);
    });
  });

});

</script>

</body>
</html>
