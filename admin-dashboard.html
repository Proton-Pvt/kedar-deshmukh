<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body{
      font-family:Inter, sans-serif;
      background:#f4f4f4;
      margin:0;
      padding:20px;
    }
    h1{text-align:center;margin-bottom:20px;}
    .btn{
      padding:8px 14px;
      background:#ff7a1a;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      font-weight:600;
      margin:4px;
    }
    .order-card{
      background:#fff;
      padding:15px;
      margin-bottom:15px;
      border-radius:10px;
      box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    .order-items{
      background:#fafafa;
      padding:10px;
      margin-top:8px;
      border-radius:8px;
    }
  </style>
</head>

<body>

<h1>Admin Dashboard</h1>

<div style="text-align:center">
  <a href="admin-complaints.html" class="btn">View Complaints</a>
</div>

<h2>Customer Orders</h2>
<div id="ordersList"></div>

<hr>

<h2>Customer Complaints</h2>
<div id="complaintsList"></div>

<script type="module">
/* ================= FIREBASE IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { 
  getFirestore, collection, query, where,
  onSnapshot, doc, updateDoc 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { 
  getAuth, onAuthStateChanged 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCrj_dMhYpdRZeKIYTAckYdqGE4f0FBz8w",
  authDomain: "restaurant-database-1ca9d.firebaseapp.com",
  projectId: "restaurant-database-1ca9d",
  storageBucket: "restaurant-database-1ca9d.firebasestorage.app",
  messagingSenderId: "772678372956",
  appId: "1:772678372956:web:1e517b1f963d58f3c1a099"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth();

/* ================= AUTH CHECK ================= */
onAuthStateChanged(auth, user => {
  if (!user) {
    alert("Please login first");
    window.location.href = "admin-login.html";
  }
});

/* ================= ORDERS ================= */
const ordersList = document.getElementById("ordersList");

onSnapshot(collection(db,"orders"), snapshot=>{
  ordersList.innerHTML = "";

  snapshot.forEach(docSnap=>{
    const o = docSnap.data();
    const id = docSnap.id;

    const items = o.items.map(i =>
      `<div>• ${i.name} (x${i.qty}) — ₹${i.price*i.qty}</div>`
    ).join("");

    ordersList.innerHTML += `
      <div class="order-card">
        <b>${o.customerName}</b><br>
        Phone: ${o.phone}<br>
        Total: ₹${o.totalAmount}<br>
        Status: ${o.status}<br>

        <div class="order-items">${items}</div>

        <br>
        <button class="btn" onclick="updateOrder('${id}','Confirmed')">Confirm</button>
        <button class="btn" onclick="updateOrder('${id}','Preparing')">Preparing</button>
        <button class="btn" onclick="updateOrder('${id}','Out for Delivery')">Out</button>
        <button class="btn" onclick="updateOrder('${id}','Completed')">Done</button>
      </div>
    `;
  });
});

window.updateOrder = async (id,status)=>{
  await updateDoc(doc(db,"orders",id),{status});
};

/* ================= COMPLAINTS ================= */
const complaintsList = document.getElementById("complaintsList");

onSnapshot(collection(db,"complaints"), snapshot=>{
  complaintsList.innerHTML = "";

  snapshot.forEach(docSnap=>{
    const c = docSnap.data();
    const id = docSnap.id;

    complaintsList.innerHTML += `
      <div class="order-card">
        Phone: ${c.phone}<br>
        Issue: ${c.description}<br>
        Status: ${c.status}<br>

        ${c.imageBase64 ? `<img src="${c.imageBase64}" style="width:120px">` : ""}

        <br><br>
        <button class="btn" onclick="updateComplaint('${id}','In Review')">Review</button>
        <button class="btn" onclick="updateComplaint('${id}','Resolved')">Resolve</button>
      </div>
    `;
  });
});

window.updateComplaint = async (id,status)=>{
  await updateDoc(doc(db,"complaints",id),{status});
};

</script>
</body>
</html>
